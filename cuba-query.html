<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="cuba-data-loading-behavior.html">
<!--
The `cuba-query` element provides an ability to load list of entities using predefined query.
See https://doc.cuba-platform.com/manual-latest/rest_api_v2_queries_config.html
-->

<dom-module id="cuba-query">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
  </template>

  <script>
    Polymer({

      is: 'cuba-query',

      behaviors: [CubaDataLoadingBehavior],

      properties: {
        /**
         * Entity name as specified in domain model class via `@Entity` annotation e.g. sec$User
         */
        entityName: String,
        queryName: String,
        /**
         * Query params
         */
        params: {
          type: Object
        }
      },

      observers: ['_optionsChanged(entityName, queryName, params.*, auto)'],

      remove: function(entity) {
        return cubaApp.deleteEntity(entity._entityName, entity.id).then(function() {
          if (!this.data || !Array.isArray(this.data)) {
            return;
          }
          for (let i = 0; i < this.data.length; i++) {
            if (this.data[i].id === entity.id) {
              this.splice("data", i, 1);
            }
          }
        }.bind(this));
      },

      _load: function() {
        return cubaApp.query(this.entityName, this.queryName, this.params);
      }

    });
  </script>
</dom-module>
