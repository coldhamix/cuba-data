<script>

  /**
   * In order to use this behavior:
   * 1. _load method should be overridden. It must return jqXHR promise.
   * 2. Call _reload method on meaningful properties changes/initialization i.e:
   *
   *  `observers: ['_reload(serviceName, method, handleAs, auto)']`
   * @polymerBehavior CubaDataLoadingBehavior
   */

  CubaDataLoadingBehavior = {

    /**
     * Fired when data loading failed
     *
     * @event load-error
     */
    properties: {
      /**
       * If true - automatically loads data
       */
      auto: {
        type: Boolean,
        value: true
      },
      data: {
        notify: true,
        readOnly: true
      },
      debounceDuration: {
        type: Number,
        value: 10
      },
      loading: {
        type: Boolean,
        notify: true,
        readOnly: true
      }
    },

    /**
     * Loads data.
     * Returns jQuery promise.
     */
    load: function() {
      var defer = $.Deferred();
      this.debounce('loading', function() {
        this._setLoading(true);
        if (this.loadRequest) {
          this.loadRequest.abort();
          defer.reject();
        }
        this.loadRequest = this._load();
        this.loadRequest.then(
            function(data) {
              this._setLoading(false);
              this._setData(data);
              defer.resolve(data);
            }.bind(this),
            function () {
              this._setLoading(false);
              this.fire("load-error");
              defer.reject();
            }.bind(this)
        );
      }, this.debounceDuration);
      return defer.promise;
    },

    _reload: function() {
      if (this.auto) {
        this.load();
      }
    },

    /**
     * This method has to be overridden to contain real loading logic.
     */
    _load: function() {
      throw new Error('Missing data loading implementation')
    }

  }
</script>